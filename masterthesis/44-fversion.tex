\section{$f$ Version of {\gkw}}
\label{sec:implementationFVersion}

As stated in Chapter \ref{sub:cancelProblem} the current version of {\gkw} implements the gyrokinetic equation with the use of the modified distribution function $g$. To preserve the established structure of the code a new numerical scheme gets introduced. To recall the right-hand side of the Vlasov equatiuon $\rhs$ is definded as
\begin{gather}
    \frac{\partial g}{\Dt} = \rhs
    \label{eq:rightHandSideRecall}
\end{gather}
which is implemented numerical with Runge Kutta (one timestep ($i \rightarrow i+1$)) as
\begin{gather}
    g^{i+1} = g^{i} + \Delta t \cdot \left(\rhs^{i+1}\right) ~.
    \label{eq:numericalSchemeModifiedDistribution}
\end{gather}
To transform the established scheme to the distribution function $\df$, Equation \ref{eq:gyrocenterDeltafSubVlasovReducedIndElectric} has to be considered and is given by
\begin{gather}
    \frac{\partial \df}{\partial t} = \rhs + \frac{Ze \vpar}{T} J_0 \Epar \fm~,
    \label{eq:gyrocenterDeltafSubVlasovReducedIndElectricRecall}
\end{gather}
where $J_0 \Epar = \gaEpar$ in the local simulation is and can be written normalised andf fourier transformed as 
\begin{gather}
    \frac{\partial \speccN{\Ffgy}{1}}{\partial \tN} = \FrhsN + \frac{2 Z \vthR \vparN}{\TR} J_0 \FEparN \fmN~.
    \label{eq:gyrocenterDeltafSubVlasovReducedIndElectricNorm}
\end{gather}
Here, the numerical Runge Kutta scheme can be expressed as
\begin{gather}
    \df^{i+1} = \df^{i} + \Delta t \cdot \left(\rhs^{i+1} + \frac{Ze \vpar}{T} J_0 \Epar^{i+1} \right) ~.
    \label{eq:numericalSchemeModifiedDistribution}
\end{gather}
Note that the established numerical scheme using the modified distribution $g$ can easily transform to the scheme using the distribution $\df$ by appling the so called \textit{$\Epar$-Correction} to the RHS. The overall new numerical scheme can be seen in Figure \ref{fig:numericalSchemeFVersion}.

\inputgraphicsHere{../pictures/methods/Numerical-Scheme-f-Version}{
	Numerical scheme used to calculate the distribution function $\df$ in {\gkw}.
}{fig:numericalSchemeFVersion}

\newpage
To implement the $\Epar$-Correction a closer look on the already existing $\Apar$-Correction will be made. The $\Apar$-Correction is used to calculate the distrubution $\df$ from the modified distribution $g$, which is necessary since most of the diagnostics need the distruibution $\df$ for calculation. To recall $g$ is defined as
\begin{gather}
	g = \df + \frac{Ze \vpar}{T} J_0 \Apar \fm ~.
	\label{eq:modifiedDistrubutionFunctionRecall}
\end{gather}
To get the gyrocenter distruibution function $\df$ one has to subtract the $\Apar$-Term, i.e. the $\Apar$-Correction, from the modified distribution $g$. This gets realised with the use of the matrix \code{matg2f} which gets definded in the module \code{matdat}. The elements are set in the subroutine \code{g2f\_correct} in the module \code{linear\_terms} and the calculation for $g$ to $\df$ gets either performed with a loop over all elements of array \code{fdisi} or in the function \code{ge\_f\_from\_g}. Implementing the $\Epar$-Correction follows the same structure. First the matrix \code{matrhs4f} (RHS for $\df$) gets introduced in the module \code{matdat} with \code{nelem\_rhs4f} number of elements defined in the module \code{dist}. The elements itself are set in the subroutine \code{epar\_correct} the main difference to \code{g2f\_correct} is the swap of minus sign and the use of $\Epar$ instead of $\Apar$. The RHS than gets correct right after the calculation of the $\Epar$ field in the subroutine \code{calculate\_rhs} in the module \code{exp\_integration}. Here, the loop method was used because it was found that the calculation of the new RHS needs 50\% longer with the \code{usmv} subroutine. The code sequence is given below. Note that the $\Epar$-Correction has to be multiplied the time step \code{deltatime} to have the correct expression for the Runge Kutta scheme.

\lstinputlisting[language=Fortran, firstline=946, lastline=951]{../gkw/src/exp_integration.F90}

Now that the $\Epar$-Correction is implemented it is important to clearify that the distribution array \code{fdisi} stores no longer the modified distribution function $g$ instead the gyrocenter distrubution $\df$. For that purpose from now on if \code{nlepar} is set to \code{.true.} {\gkw} gets executed in the \textbf{f-version}. Otherwise, if \code{nlepar} is set to \code{.false.} the so called \textbf{g-version} of {\gkw} will be used. If \code{nlepar} is set to \code{.true.}, {\gkw} switches to the f-version of the code. Additionally, a warning messages will be printed, that the user now uses the f-version of {\gkw}. If needed, a new switch called \code{fversion} could be implemented to turn all necessary switches on. Until now \code{nlepar} will be used for that purpose. In the subroutine \code{control\_initt} one could add additonal switches for the f-version of {\gkw} into the given code sequence below.
\lstinputlisting[language=Fortran, firstline=677, lastline=681]{../gkw/src/control.f90}

Furthermore, it is necessary to prevent any code sequence which was meant for the modified distrubution function, i.e. the application of the $\Apar$-Correction. For that any code sequence using the $\Apar$-Correction will get deactivated if \code{nlepar} is set to \code{.true.}. Since most sequences define a new temporary distribution array \code{fdis\_tmp} and the upcoming code uses this variable it was convienent to just save \code{fdisi} in \code{fdis\_tmp} for the f-version of {\gkw}. Additionally, the function \code{get\_f\_from\_g} gets modified to return just \code{fdisi} and the definition of the matrix \code{matg2f} gets supressed as well to save disk space during execution. \bigskip

As last step the field equation of the perturbated vector potential $\Apar$ has to be adjusted, since it is the only field equation which changes significantly through the substitution of the modified distribution $g$ [Ch. \ref{sub:cancelProblem}]. For that, an if statemant for the f-version gets introduced intoe the subroutine \code{ampere\_dia} in the module \code{linear\_terms} which deactivates the skin term if \code{nlepar} is set to \code{.true.}. As already mentioned the other field equation are still implemented right for \code{fdisi} as distribution $\df$.

\newpage

\subsection*{Benchmark of $f$ Version of {\gkw} - Linear $\beta$ Scan}
\label{sub:benchmarkFVersion}

\includegraphicsHere{../pictures/evaluation/benchmark/comparison/kthrho0.300_beta0.000-0.022_scan_comparison.pdf}{
    Growth rate $\gamma$ and frequency $\omega$ for different plasma beta $\beta$. Here, (ITG) stands for ion temperature gradient modes, (TEM) for trapping electron modes and (KBM) for kinetic balloning modes.
}{fig:betaScanFVersion}{1.0}

Again the same benchmark as in Chapter \ref{sec:implementationFieldEpar} will be performed with the same simulation setup. The only difference is that the the plasma bata was varied between
\begin{gather}
    \beta \in [0.0,~0.2,~0.4,~0.6,~0.8,~1.0,~1.1,~1.2,~1.4,~1.6,~1.8,~2.0,~2.2]\,\%~.
\end{gather}
The result of the linear beta scan of the f-version yields great agreement with the one of the g-version [Fig. \ref{fig:betaScanFVersion}] only for $\beta = 1.1\,\%$ the values are significant different. This can be explained with the run time of both simulations since the simulation for the g-version run for 5438 normalised timesteps, where the f-version only run for 2000 normalised timesteps. The other simulations run the same noramlized timesteps as the g-version. To verify, that the f-version of {\gkw} calculates the field equation for the plasma induction $\Apar$ right, since the field equation got changed (compare Eq. (\ref{eq:fieldInductionLocalNorm}) and (\ref{eq:fieldInductionLocalModifiedNorm})), the plasma induction gets compared again with the induced electric field $\Epar$ [Fig. \ref{fig:fieldComparisionFVersion}]. Here, the comparision again shows that the field equations are implemented successfully. The only difference exists for $\beta = 1.1\,\%$, which is also the result of the much shorter run time of the simulation. For a more detailed look for different plasma beta values the reader is referred to Appendix \ref{subappend:fieldComparisionFVersion}.

% TODO: Run simulations for f-version longer (?)

\includegraphicsRotHere{../pictures/evaluation/benchmark/comparison/kthrho0.300_beta0.000-0.022_fields_f-version.pdf}{
    Comparision between real and imaginary part of the induced electric field $\Epar$ and plasma Induction $\Apar$ for different plasma beta values for the f-verison of {\gkw}.
}{fig:fieldComparisionFVersion}{0.94}

% TODO: Add plots which show timetrace of gamma and omega (?)

\subsection*{Mitigation of Cancellation Problem in linear Simulations}
\label{sub:mitigationLinearLocal}

One of the main goals of this thesis is to mitigate the cancellation problem [Ch. \ref{sub:cancelProblem}] in local simulations. The error of problem scales with $\sim \beta/\kperp^2$ \cite{Mishchenko2017}. Because of that, it was investigated if the new f-version improves code run time for lower perpendicular wave vectors $\kperp$. First, a $\kperp$ scan was performed with the g-version of {\gkw} and cyclone base case for $\beta = 0.8\,\%$ to find the transition between stable simulations and instable ones. Here, it was found that the simulation get instable for $\kperp = 0.027\,1/\rhothref$. Unfortnetaly, the f-version gets also instable for the exat same value of $\kperp$. To further investigate the behaviour of the plasma induction by changing \code{naverage} to 1. 

% TODO: Add results

\subsection*{AUG Testcases}
\label{sub:mitigationLinearLocal}

\newpage