\section{Faraday's law in {\gkw}}
\label{sec:simFieldEpar}

\subsection{Implementation}
\label{sub:implementationFieldEpar}

Since the code is capable of parallization the inserted code is written to use the OpenMPI libary. Further subtle changes or import statements will not be stated since most are following the established stucture of $\Apar$ and add them for $\Epar$ into the code as well. The reader is referred to the branch in bibucket\cite{FeatureEparBitbucket} for more in depth documentation on the process and implementation.
\bigskip

Before detailing the implementation for the calculation of $\Epar$, the scheme of the calculation needs to be discussed. As stated in Equation (\ref{eq:fieldElectricLocalNorm}) the right-hand side of the Vlasov equation $\rhs$ (RHS) is necessary for the calculation of $\Epar$. Now, if one takes a closer look at Equations (\ref{eq:modifiedDistributionFunction}) and (\ref{eq:gyrocenterDeltafSubVlasovReduced}) it can be derived as
\begin{gather}
    \frac{\partial g}{\Dt} = \rhs~,
    \label{eq:rightHandSide}
\end{gather}
where $g$ is the modified distribution. Since {\gkw} has already implemented $\partial_t g$ as \code{rhs} and the Vlasov equation with the modified distribution function [Eq (\ref{eq:modifiedGyrocenterDeltafSubVlasov})] has only one additional term containing $g$, which is nonlinear, i.e. ignored in linear cases, \code{rhs} will be used as the right-hand side of the Vlasov equation in the calculation of $\Epar$. In the next step the numerical scheme for every Runge Kutta step ($i \rightarrow i+1$) has to be considered. Figure \ref{fig:numericalSchemeEpar} gives an illustration of the scheme.

\inputgraphicsHere{../pictures/methods/Numerical-Scheme-Epar}{
	Numerical scheme used to calculate the plasma induction $\Epar$ in {\gkw}. First the modified distribution function $g$ for the time step $i$ is used to calculate the RHS $\rhs$ for the time step $i+1$, which calculates the plasma induction $\Epar$ and distribution $g$ for timestep $i+1$.
}{fig:numericalSchemeEpar}

As shown, the order of calculations is important in the numerical scheme, i.e. first calculate the right-hand side of the Vlasov equation $\rhs$ and afterwards the induced electric field $\Epar$. 

\newpage

To add the plasma induction $\Epar$ into {\gkw} the following changes were applied:
\begin{itemize}
    \item The boolean input parameter \code{nlepar} was added in the \code{control} module to activate the calculation of the $\Epar$ field. Since the simulation has to be electromagnetic, the switch for the $\Apar$ field will also be turned on.
    \item In the module \code{dist} the identifiers for the $\Epar$ and $\gaEpar$ are declared \code{iepar} and \code{iepar\_ga}. These identifieres make it possible to access only $\Epar$ and $\gaEpar$ in the solution \code{fdisi} with the use of the index function from the module \code{index\_function}. Additionally, the grid points, ghost cells and the size of the additional field matrices are defined in the module \code{dist} as well.
    \item A new subroutine called \code{calculate\_additional\_fields} is introduced in the module fields. As stated before the calculation of the $\Epar$ needs the RHS as argument an in the subroutine. As parameter the calculated variable \code{rhs} from the module \code{exp\_integration} will be used. Additionally, the variable \code{rhs} has to be devided by the timestep \code{deltatime} from the Runge Kutta scheme, because \code{rhs} is the product of the right-hand side $\rhs$ and the timestep \code{deltatime}. Here, the timestep \code{deltatime} is parsed by the argument \code{DTIM} in \code{calculate\_additional\_fields} and originate from the module \code{exp\_integration}. The calculation is performed in two steps:
    \begin{enumerate}
        \item [(1)] Matrix vector multiplication of the matrix containing the integral part of $\Epar$ with the "pure" right-hand side array \code{rhs/DTIM} \\
                    \code{fdisi = mat\_add\_field\_int \ast~(rhs / DTIM) }
        \item [(2)] Division of the matrix containing the diagonal part of $\Epar$ \\
                    \code{fdisi = fdisi / mat\_add\_field\_diag}.
    \end{enumerate}
    To achieve the structure shown in Figure \ref{fig:numericalSchemeEpar} the calculation of $\Epar$ is performed after the subroutine \code{calculate\_rhs} from the module \code{exp\_integration}.
    \item The matricies \code{mat\_add\_field\_int} and \code{mat\_add\_field\_diag} are defined in the module \code{matdat}. Here, the matrix \code{mat\_add\_field\_int} contains the linear term \code{faraday\_int} and \code{mat\_add\_field\_diag} the term \code{faraday\_diag}. Both matrix elements are calculated in the module linear terms and are given by
    \begin{gather}
        \begin{aligned}
            \texttt{faraday\_int} &= - 2\pi\BN \betaref \spec{\sum} \spec{Z} \specR{n} \specthR{v} \ints \dvparN \dmuN ~ \vparN J_0(\kperp \spec{\rho})\\
            \texttt{faraday\_dia} &= \left(\kperpN^2 + \betaref \spec{\sum} \frac{\spec{Z^2}\specR{n}}{\specR{m}} \Gamma_0(\spec{b}) e^{-\specN{\cfen}/\specR{T}} \right)~.
        \end{aligned}
    \end{gather}
    Note that, the $2\pi$ factor in \code{faraday\_int} is already included in the array \code{intmu} \cite{GKWManual} and will be ignored. The size of the matrices are given by \code{nelem\_regular\_fields}. During the optimization of the number of elements for \code{mat\_add\_field\_int} and \code{mat\_add\_field\_diag} it was found that \code{nelem\_additional\_fields} cannot be further reduced. Plausibly, the field matrices for the additional fields have to account for the number of elements for regular field matrices as well.
    \item To extract $\Epar$ from \code{fdisi} the subroutine \code{get\_epar} is needed in the diagnostic \code{diagnos\_mode\_struct} which outputs the data of parallel quantities. Here, \code{get\_epar} either returns the data for the $\Epar$ field in two columns, sorted by real and imaginary part, or two zero colums, if the \code{nlepar} switch is off. Additionally, the code is adjusted to the additional field and the variables \code{epar} and \code{eperp} are renamed to \code{ene\_par} and \code{ene\_perp}. Due to the new additional data sets and the definition of \code{get\_epar} the testcases
    \begin{itemize}
        \item \code{adiabat\_collisions\_momcon\_ap},
        \item \code{chease\_cf\_modebox},
        \item \code{collisions\_please\_dont\_break\_me} and
        \item \code{zonal\_flow\_sixth\_order\_FD}
    \end{itemize}
    have to be adjusted to contain the two zero columns from $\Epar$ in the parallel data.
\end{itemize}

\newpage

\subsection{Benchmark}
\label{sub:benchmarkFieldEpar}

To benchmark the implementation of Faraday's law with $\Epar$ multiple linear simulations for different plasma beta $\beta$ are performed. The goal is to extract the linear growth rate $\gamma$ and frequency $\omega$ o the most dominant mode to compare the result for $\Epar$ with $\Apar$. In general a given quantity is saved in \code{parallel.dat} in two columns containing real and imaginary values. The rows are sorted by the species $\Nsp$, binormal gird points $\Nmod$, radial grid points $\Nx$ and grid points along the field line $\Ns$ and therefore $\Nsp\Nmod\Nx\Ns$ rows. The data stored in \code{parallel.dat} is defined as
\begin{gather}
    \widehat{L}(s,t) = \exp (\gamma t + i\omega t) \widehat{L}(s)~,
    \label{eq:parallelData}
\end{gather}
where $\widehat{L}(s,t)$ is the calculated quantity and $\widehat{L}(s)$ is the stored value. \cite{GKWManual} Note that, $\widehat{L}(s,t)$ and $\widehat{L}(s)$ are complex. With Equation (\ref{eq:parallelData}) one can derive the relation between $\FEpar$ and $\FApar$ with Faraday's law [Eq. (\ref{eq:faradayLaw})] as
\begin{gather}
    \begin{aligned}
        \FEpar(s,t) &= - \partial_t \FApar(s,t) \\
        \exp (\gamma t + i\omega t) \FEpar(s) &= - \partial_t \left[\exp(\gamma t + i\omega t) \FApar(s)\right] \\
        \FEpar(s) &= - (\gamma + i\omega) \FApar(s) \\
        \FEpar^\mathrm{R}(s) + i \FEpar^\mathrm{I}(s) &= - (\gamma + i\omega) \left(\FApar^\mathrm{R}(s) + i \FApar^\mathrm{I}(s)\right)
    \end{aligned} \\[0.5cm] 
    \Rightarrow \boxed{
    \begin{aligned}
        \FEpar^\mathrm{R}(s) &= - \gamma \FApar^\mathrm{R}(s) + \omega \FApar^\mathrm{I}(s) \\ 
        \FEpar^\mathrm{I}(s) &= - \omega \FApar^\mathrm{R}(s) - \gamma \FApar^\mathrm{I}(s)   
    \end{aligned}
    } \nonumber
    \label{eq:parallelDataEparEqApar}
\end{gather}

% \subsection*{Simulation Setup}
For the plasma beta following values are investigated
\begin{gather}
    \beta \in [0.0,~0.2,~0.4,~0.6,~0.8,~1.0,~1.1,~1.2,~1.4,~1.6]\,\%~.
\end{gather}
The values will be set with the parameter \code{beta} in the input file. As base input file the cyclone benchmark case (CBC) with $s$-$\alpha$ geometry provided by the {\gkw} Team was used. Here, $s$-$\alpha$ geometry implies that the flux surfaces is being circular and has a small inverse aspect ratio $r/R_0$, where $r$ is the radius of the flux surface and $R_0$ the major radius [Ch. \ref{sec:confinement}]. The input file can be found in the {\gkw} repository under \code{doc/input/cyclone}. Here, the input parameters were adjusted for linear $\beta$ scan and are displayed in Table \ref{tab:adjustInputparameter}. 

\newpage

Additionally following parameter were set
\begin{itemize}
    \item \code{NON\_LINEAR} = \code{.false.} to enable linear simulations, 
    \item \code{nlepar}      = \code{.true.} to enable the calculatation of $\Epar$,
    \item \code{io\_format}  = \code{'hdf5} output data to \code{hdf5} format,
    \item \code{gama\_tol}   = $1 \cdot 10^{-5}$ defines tolerance for linear growth rate $\gamma$,
    \item \code{adiabatic\_electrons} = \code{.false.} to enable kinetic electrons,
    \item \code{mode\_box}   = \code{.false.} deactivates 2D mode grid and
    \item $k_\zeta \rho$     = 0.3 defines \enquote{poloidal} wave vector which corresponds roughly to the position of the maximum of the nonlinear transport spectrum in {\gkw}.
\end{itemize}
\begin{center}
    \centering
    \captionsetup{type=table}
    \begin{tabular}{c c c | c c c c c c c}
        \code{DTIM} & \code{NTIME} & \code{NAVERAGE} & $\Nmod$ & $\Nx$ & $\Ns$ & $\Nvpar$ & $\Nmu$ & $\Nsp$ & \code{nperiod} \\ \hline
        0.01 & 2000 & 100 & 1 & 1 & 288 & 64 & 16 & 2 & 5
    \end{tabular}
    \captionof{table}{Adjusted input parameter for linear $\beta$ scan: Initial time step size \code{DTIM}, \code{NTIME} is the number of iterations of \code{NAVERAGE}, number of timesteps between re-normalisation \code{NAVERAGE}, number of binormal grid points $\Nmod$, number of radial gird points $\Nx$,number of grid points along the magnetic field $\Ns$, number of parallel velocity grid points $\Nvpar$, numbe magnetic moment grid points $\Nmu$, number of species $\Nsp$ and \code{nperiod} as integer which specify the length of the field line.}
    \label{tab:adjustInputparameter}
\end{center}

% \subsection*{Results}

The result of the linear $\beta$ scan can be seen in Figure \ref{fig:betaScanGVersion}. The obtained data shows agreement with Ref. \citenum{Crandall_PHD} and \citenum{Leppin_PHD}, although GENE normalises with speed of sound and {\gkw} normalise by the thermal velocity $\vth$, the values are $\sqrt{2}$ times smaller. Furthermore, by comparing the beta scan in Ref. \citenum{Crandall_PHD} or \citenum{Leppin_PHD} and Figure \ref{fig:betaScanGVersion} the transition from ion temperature gradient mode (ITG) to kinetic ballooning mode (KBM) are located at notably different values of plasma beta $\beta$. This behaviour is due to different values for the wave vector $k_\zeta \rho$ and the resolution of parallel velocity grid $\Nvpar$. The comparison between the plasma induction $\Epar$ and vector potential $\Apar$ yields the implementation of the $\Epar$ field equation as successful. An overall camparison is shown in Figure \ref{fig:fieldComparisionGVersion} and for a more detailed look for different plasma beta values the reader is referred to Appendix \ref{subappend:fieldComparisionGVersion}.

\includegraphicsHere{../pictures/evaluation/benchmark/g-version/growth_rate_freq/kthrho0.300_beta0.000-0.016_scan_g-version.pdf}{
    Growth rate $\gamma$ and frequency $\omega$ for different plasma beta $\beta$. Here, (ITG) stands for ion temperature gradient modes and (KBM) for kinetic ballooning modes.
}{fig:betaScanGVersion}{1.0}

\includegraphicsRotHere{../pictures/evaluation/benchmark/comparison/fields/kthrho0.300_beta0.000-0.016_fields_g-version.pdf}{
    Comparision between real and imaginary part of the plasma induction $\Epar$ and vector potential $\Apar$ for different plasma beta values for the g-verison of {\gkw}.
}{fig:fieldComparisionGVersion}{0.94}

\newpage